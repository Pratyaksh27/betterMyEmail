(()=>{"use strict";var e={d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{H:()=>p,Y:()=>b});const t={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let o;const n=new Uint8Array(16);function l(){if(!o){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");o=crypto.getRandomValues.bind(crypto)}return o(n)}const a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));const i=function(e,o,n){if(t.randomUUID&&!o&&!e)return t.randomUUID();const i=(e=e||{}).random||(e.rng||l)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,o){n=n||0;for(let e=0;e<16;++e)o[n+e]=i[e];return o}return function(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}(i)};class s{static getFeedbackData(){return{totalUses:localStorage.getItem(s.totalUsesKey),lastFeedbackTime:localStorage.getItem(s.lastFeedbackTimeKey),lastFeedbackGiven:localStorage.getItem(s.lastFeedbackGivenKey),usesSinceLastFeedback:localStorage.getItem(s.usesSinceLastFeedbackKey),recommendationsAccepted:localStorage.getItem(s.recommendationsAcceptedKey),recommendationsDiscarded:localStorage.getItem(s.recommendationsDiscardedKey)}}static resetFeedbackData(){localStorage.removeItem(s.totalUsesKey),localStorage.removeItem(s.lastFeedbackTimeKey),localStorage.removeItem(s.lastFeedbackGivenKey),localStorage.removeItem(s.usesSinceLastFeedbackKey),localStorage.removeItem(s.recommendationsAcceptedKey),localStorage.removeItem(s.recommendationsDiscardedKey)}static incrementUsage(e){let t=parseInt(localStorage.getItem(s.totalUsesKey)||"0");t++,localStorage.setItem(s.totalUsesKey,t.toString());let o=parseInt(localStorage.getItem(s.usesSinceLastFeedbackKey)||"0");if(o++,localStorage.setItem(s.usesSinceLastFeedbackKey,o.toString()),e){let e=parseInt(localStorage.getItem(s.recommendationsAcceptedKey)||"0");e++,localStorage.setItem(s.recommendationsAcceptedKey,e.toString())}else{let e=parseInt(localStorage.getItem(s.recommendationsDiscardedKey)||"0");e++,localStorage.setItem(s.recommendationsDiscardedKey,e.toString())}console.log("Incremented usage"),console.log("Total Uses: "+t),console.log("Uses Since Last Feedback: "+o)}static shouldShowFeedbackPopup(){const e=localStorage.getItem(s.lastFeedbackGivenKey||"false"),t=parseInt(localStorage.getItem(s.usesSinceLastFeedbackKey)||"0");if(null===localStorage.getItem(s.lastFeedbackGivenKey)&&localStorage.setItem(s.lastFeedbackGivenKey,"false"),"true"===e){let e=t>=5;return e&&localStorage.setItem(s.usesSinceLastFeedbackKey,"0"),e}if("false"===e){let e=t>=3;return e&&localStorage.setItem(s.usesSinceLastFeedbackKey,"0"),e}return!1}}s.totalUsesKey="totalUses",s.lastFeedbackTimeKey="lastFeedbackTime",s.lastFeedbackGivenKey="lastFeedbackGiven",s.usesSinceLastFeedbackKey="usesSinceLastFeedback",s.recommendationsAcceptedKey="recommendationsAccepted",s.recommendationsDiscardedKey="recommendationsDiscarded";var r=function(e,t,o,n){return new(o||(o=Promise))((function(l,a){function i(e){try{r(n.next(e))}catch(e){a(e)}}function s(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?l(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,s)}r((n=n.apply(e,t||[])).next())}))},c=function(e,t,o,n){return new(o||(o=Promise))((function(l,a){function i(e){try{r(n.next(e))}catch(e){a(e)}}function s(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?l(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,s)}r((n=n.apply(e,t||[])).next())}))};let d=!1;const m=new class{constructor(){this.selectedRating=null}injectFeedbackForm(){return r(this,void 0,void 0,(function*(){try{const e=yield fetch(chrome.runtime.getURL("dist/client/user_feedback/feedbackForm.html")),t=yield e.text(),o=document.createElement("div");o.innerHTML=t.trim();const n=o.querySelector("style");n?document.head.appendChild(n):console.error("Feedback form styles not found in the loaded HTML.");const l=o.querySelector("#feedbackFormContainer");l?(document.body.appendChild(l),this.initializeFeedbackFormEvents()):console.error("Feedback form container not found in the loaded HTML.")}catch(e){console.error("Error loading feedback form HTML:",e)}}))}initializeFeedbackFormEvents(){const e=document.getElementById("feedbackCloseBtn"),t=document.getElementById("feedbackSubmitBtn"),o=document.getElementById("feedbackEmojiContainer"),n=document.getElementById("feedbackText");e&&(e.onclick=()=>{this.hideFeedbackForm()}),t&&(t.onclick=()=>{const e=n.value.trim();this.selectedRating||e?(this.submitFeedback(this.selectedRating,e),this.hideFeedbackForm()):alert("Please provide a rating or some text feedback.")}),o&&o.addEventListener("click",(e=>{const t=e.target;t.dataset.value&&(this.selectedRating=parseInt(t.dataset.value,10),Array.from(o.children).forEach((e=>{e.style.filter="none"})),t.style.filter="drop-shadow(0 0 5px #1a73e8)")}))}showFeedbackForm(){console.log("Feedback UI : Will display feedback form");const e=document.getElementById("feedbackFormContainer");e&&(console.log("Feedback UI : Feedback Form Found"),e.style.display="block")}hideFeedbackForm(){const e=document.getElementById("feedbackFormContainer");e&&(e.style.display="none"),this.selectedRating=null;const t=document.getElementById("feedbackText");t&&(t.value="")}submitFeedback(e,t){return r(this,void 0,void 0,(function*(){const o=localStorage.getItem("userUUID");if(!o)return console.log("User UUID not found in localStorage. Will NOT submit feedback."),void console.error("User UUID not found in localStorage. Will NOT submit feedback.");e||(e=-1),t||(t="Not Given by User. Only Rating provided"),console.log("Submitting Feedback:",{rating:e,feedbackText:t});const n={uuid:o,rating:e,feedback:t};console.log("Feedback Payload is :",n);try{const e=(yield b()).app_URL+"/submitFeedback";if(console.log("Submitting feedback to:",e),!e)return void console.error("Feedback URL not found in configs. Will NOT submit feedback.");(yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).ok&&(console.log("Feedback submitted successfully."),localStorage.setItem("lastFeedbackGiven","true"))}catch(e){console.error("Error submitting feedback:",e)}}))}};function u(){return c(this,void 0,void 0,(function*(){console.log("emailAnalysisResultDialog.ts: Inside updateUsageCount");let e=localStorage.getItem(s.totalUsesKey),t=localStorage.getItem(s.usesSinceLastFeedbackKey),o=localStorage.getItem("userUUID"),n=localStorage.getItem(s.recommendationsAcceptedKey),l=localStorage.getItem(s.recommendationsDiscardedKey);console.log("emailAnalysisResultDialog.ts: Usage Stats: ",{uuid:o,total_uses:e,uses_since_last_feedback:t,recommendations_accepted:n,recommendations_discarded:l});const a={uuid:o,total_uses:e,uses_since_last_feedback:t,recommendations_accepted:n,recommendations_discarded:l};try{const e=(yield b()).app_URL+"/submitUsageStats";console.log("emailAnalysisResultDialog.ts: Updating Usage Stats to:",e),(yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok&&console.log("Usage Stats submitted successfully.")}catch(e){console.error("Error submitting usage stats:",e)}}))}m.injectFeedbackForm().then((()=>{console.log("Email Analysis Result Dialog: Feedback Form injected successfully")}));var g=function(e,t,o,n){return new(o||(o=Promise))((function(l,a){function i(e){try{r(n.next(e))}catch(e){a(e)}}function s(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?l(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,s)}r((n=n.apply(e,t||[])).next())}))};function y(e,t){return g(this,void 0,void 0,(function*(){console.log("betterMyEmailPlugin.ts: createUser() called with uuid and email ID");const o=(yield b()).app_URL+"/createUser";yield fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emailID:e,UUID:t})})}))}function f(e){return g(this,void 0,void 0,(function*(){console.log("betterMyEmailPlugin.ts: getEmailFromUUID() called");const t=(yield b()).app_URL+"/getEmailFromUUID";try{const o=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuid:e})}),n=yield o.json();return console.log("betterMyEmailPlugin.ts: getEmailFromUUID() Successfully Called: "),n.emailID?n.emailID:null}catch(e){return console.error("betterMyEmailPlugin.ts: getEmailFromUUID() Error: ",e),null}}))}function b(){return new Promise(((e,t)=>{chrome.storage.sync.get(["config"],(function(o){o.config?(console.log("betterMyEmailPlugin.ts: getConfigs() Configs found: "),e(o.config)):(console.log("betterMyEmailPlugin.ts: getConfigs() Configs NOT found"),t(new Error("Configs not found.")))}))}))}function p(e){return g(this,void 0,void 0,(function*(){console.log("betterMyEmailPlugin.ts: Inside fetchBetterMyEmailAPI"),document.getElementById("betterMyEmailSpinner").style.display="block";const e=document.querySelector('[role="textbox"][aria-label*="Message Body"]');if(!e)return void console.error("betterMyEmailPlugin.ts: Email content not found");let t=function(e){const t=[/On .* wrote:/,/Forwarded message:/,/-----Original Message-----/];let o=e;for(const e of t){const t=o.match(e);if(t){o=o.slice(0,t.index).trim();break}}return o}((null==e?void 0:e.innerHTML)||""),{body:o,signature:n}=function(e){const t=[/<div class="gmail_signature">[\s\S]*<\/div>/s,/<table[\s\S]*?<\/table>/s,/<tr[\s\S]*<\/tr>/s,/<td[^>]*border-top:[^>]*>[\s\S]*?<\/td>/s];let o="",n=e;for(const e of t){const t=n.match(e);if(t){o=t[0],n=n.replace(o,"").trim();break}}return{body:n,signature:o}}(t);o=h(o),function(e){const t=document.createElement("div");t.innerHTML=e,t.textContent}(o);const l=localStorage.getItem("selectedTone")||"professional";console.log("betterMyEmailPlugin.ts fetchBetterMyEmailAPI() Selected Tone: ",l);try{const e=yield b();console.log("betterMyEmailPlugin.ts fetchBetterMyEmailAPI() Configs: ",e),e&&e.analysis_URL?yield fetch(`${e.analysis_URL}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emailContent:o,selectedTone:l})}).then((e=>(console.log("betterMyEmailPlugin.ts: Better my Email Analysis Responded: "),e.json()))).then((e=>{if(!e)return void console.error("betterMyEmailPlugin.ts Error: Data received from Better my Email Analysis");if(!e.analysisResult)return void console.error("betterMyEmailPlugin.ts Error: Data does not have a analysisResult property");let t;try{const o=e.analysisResult.replace(/```json|```/g,"").trim();t=JSON.parse(o)}catch(e){return void console.error("betterMyEmailPlugin.ts Error: Parsing analysisResult JSON: ",e)}let o=t.recommended_email;o=h(o);const l=`${o}${n}`,a=t.rationale;document.getElementById("betterMyEmailSpinner").style.display="none",function(e){fetch(chrome.runtime.getURL("dist/client/email_analysis/emailAnalysisResultUI.html")).then((e=>e.text())).then((t=>{const o=document.createElement("div");o.innerHTML=t,document.body.appendChild(o);const n=document.getElementById("betterMyEmailDialog"),l=document.getElementById("recommendedEmailContent"),a=document.getElementById("rationaleContent"),i=document.getElementById("acceptButton"),r=document.getElementById("discardButton");if(!(n&&l&&a&&i&&r))return void console.error("Email Analysis Result Dialog Error: Elements not found in the external HTML");const c=e.recommendedEmail.replace(/\n/g,"<br>");l.innerHTML=c;let g="";if("string"==typeof e.rationale)g=e.rationale.replace(/\n/g,"<br>");else if("object"==typeof e.rationale)for(const[t,o]of Object.entries(e.rationale))g+="string"==typeof o?`<strong>${t}:</strong> ${o.replace(/\n/g,"<br>")}<br>`:`<strong>${t}:</strong> ${o}<br>`;else g="Email Analysis Result Dialog: No rationale provided by AI.";a.innerHTML=g,n.showModal(),d||function(){const e=document.getElementById("toneDropdown");if(!e)return void console.error("Email Analysis Result Dialog: Tone Dropdown not found");d=!0;const t=localStorage.getItem("selectedTone")||"professional";e.value=t,e.addEventListener("change",(e=>{const t=e.target.value;localStorage.setItem("selectedTone",t),console.log(`Selected tone saved: ${t}`);const o=document.getElementById("betterMyEmailDialog");o&&o.close(),console.log("Calling fetchBetterMyEmailAPI due to tone change..."),p().then((()=>{console.log("Email Analysis Result Tone Dropdown: fetchBetterMyEmailAPI() called successfully")})).catch((e=>{console.error("Email Analysis Result Tone Dropdown: fetchBetterMyEmailAPI() failed:",e)}))}))}(),i.onclick=()=>{s.shouldShowFeedbackPopup()&&(console.log("Email Analysis Result Dialog: Accept Button Clicked, showing Feedback Form"),m.showFeedbackForm()),function(e){const t=document.querySelector('[role="textbox"][aria-label*="Message Body"]');t?t.innerHTML=e.replace(/\n/g,"<br>"):console.error("Email Analysis Result Dialog:: Email Content Element not found")}(e.recommendedEmail),n.close(),s.incrementUsage(!0),u()},r.onclick=()=>{s.shouldShowFeedbackPopup()&&(console.log("Email Analysis Result Dialog: Discard Button Clicked, showing Feedback Form"),m.showFeedbackForm()),n.close(),s.incrementUsage(!1),u()},n.addEventListener("close",(()=>{console.log("Email Analysis Result Dialog: Dialog closed")}))})).catch((e=>console.error("Email Analysis Result Dialog: Failed to load the analysis result UI:",e)))}({recommendedEmail:l,rationale:a})})).catch((e=>{console.error("betterMyEmailPlugin.ts: Error in Better my Email Analysis: ",e)})):console.error("betterMyEmailPlugin.ts fetchBetterMyEmailAPI() Configs not found")}catch(e){console.error("betterMyEmailPlugin.ts: Error in Better my Email Analysis: ",e)}}))}function E(){const e=document.querySelector('[role="button"][aria-label*="Send"], [role="button"][data-tooltip*="Send"]');if(e&&e.parentNode){if(!e.nextSibling||"Better My Email"!==e.nextSibling.textContent){const t=function(){const e=document.createElement("button");return e.textContent="Better My Email",e.style.cssText="background-color: #1a73e8; color: white; padding: 5px 5px; cursor: pointer; display: inline-block; margin-left: 0px;",e.onclick=p,e}();e.parentNode.insertBefore(t,e.nextSibling)}console.log("betterMyEmailPlugin.js: Send Button Found.")}else setTimeout(E,1e3)}function h(e){let t=e;return[/\[Your Name\]/g,/\[Your Position\]/g,/\[Your Company\]/g,/\[Your Team\]/g,/\[Your Contact Information\]/g,/\[Recipient's Name\]/g,/\[Recipient's Position\]/g,/\[Recipient's Company\]/g,/\[Your Company\/Team Name\]/g,/\[Insert .*?\]/g].forEach((e=>{t=t.replace(e,"").trim()})),t}console.log("betterMyEmailPlugin.js - Start"),function(){console.log("betterMyEmailPlugin.ts: Script executing immediately after load"),function(){g(this,void 0,void 0,(function*(){console.log("Starting UUID to Email Mapping..."),yield function(){return g(this,void 0,void 0,(function*(){console.log("Ensuring Email Consistency Between Local Storage & Extension Storage");let e=localStorage.getItem("userEmailID")||null,t=yield new Promise((e=>{chrome.storage.sync.get("storedEmail",(t=>{t&&"string"==typeof t.storedEmail?e(t.storedEmail):e(null)}))}));t&&!e?(localStorage.setItem("userEmailID",t),console.log("Synced ESEmail to LSEmail:")):!t&&e?(chrome.storage.sync.set({storedEmail:e}),console.log("Synced LSEmail to ESEmail:")):t&&e?(localStorage.setItem("userEmailID",t),console.log("Ensured ES priority while syncing emails in Local and Extension Storages")):console.log("No Email found in LS or ES.")}))}();let e=localStorage.getItem("userUUID"),t=localStorage.getItem("userEmailID");if(!e&&t){console.log("UUID missing but Email exists. Retrieving UUID from DB...");const o=yield function(e){return g(this,void 0,void 0,(function*(){console.log("betterMyEmailPlugin.ts: getUUIDFromEmail() called ");const t=(yield b()).app_URL+"/getUUIDFromEmail";try{const o=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emailID:e})}),n=yield o.json();return console.log("betterMyEmailPlugin.ts: getUUIDFromEmail() Successfully Called "),n.uuid?n.uuid:null}catch(e){return console.error("betterMyEmailPlugin.ts: getUUIDFromEmail() Error: ",e),null}}))}(t);o?(localStorage.setItem("userUUID",o),console.log("Restored UUID from DB:",o)):(console.log("No UUID found in DB. Creating new UUID.."),e=i(),localStorage.setItem("userUUID",e),y(t,e))}else if(e&&!t){console.log("UUID exists but Email is missing. Retrieving Email from DB...");const t=yield f(e);t&&(localStorage.setItem("userEmailID",t),chrome.storage.sync.set({storedEmail:t}),console.log("Restored Email from DB:"))}else e||t?e&&t&&(console.log("UUID & Email are already present."),(yield f(e))||(console.log("Creating User in DB with existing UUID & Email..."),y(t,e))):(console.log("No UUID and No Email found. Generating a new UUID..."),e=i(),localStorage.setItem("userUUID",e))}))}();new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.length>0&&E()}))})).observe(document.body,{childList:!0,subtree:!0}),E(),document.body.insertAdjacentHTML("beforeend",(console.log("Spinner : getSpinnerHTML called"),'\n        <div id="betterMyEmailSpinner" style="display:none; position: fixed; z-index: 999999; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;">\n            <div style="border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #3498db; width: 60px; height: 60px; -webkit-animation: spin 2s linear infinite; animation: spin 2s linear infinite;"></div>\n        </div>\n\n        <style>\n            @-webkit-keyframes spin {\n            0% { -webkit-transform: rotate(0deg); }\n            100% { -webkit-transform: rotate(360deg); }\n            }\n\n            @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n            }\n        </style>\n    '))}()})();